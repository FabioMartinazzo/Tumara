var fs = require('fs')
var xml2js = require('xml2js')
var path = require('path')
var utilities = require('./utilities')

var Logger = {
	writeToFile : function(req, msg, callback, fileKind) {

		return fs.readFile(path.dirname(require.main.filename) + '/config/config.xml', function(err, data) {
			var parser = new xml2js.Parser()
			return parser.parseString(data, function (err, fileObj) {
				if (err) {
					console.log('Arquivo de configuração inválido.')
					return callback()
				}

				return fileObj.xml.config.forEach(function(node) {
					var path = node.logs[0].path[0]
					var access = node.logs[0].access[0]
					var error = node.logs[0].error[0]
					var verbose = node.logs[0].verbose[0]

					var fileName = ''
					var fileKindStr = ''

					if (fileKind == 0) {
						fileName = access
						fileKindStr = 'acesso'
					} else {
						fileName = error
						fileKindStr = 'erro'
					}

					var msgNoLN = msg + ((req != undefined) ? (" - Follower : " + 
							 utilities.getFollower(req) + utilities.getAccessIp(req, true)) : '') +  							 	 utilities.getCurrentDate(true, true)
					msg = msgNoLN + utilities.lineBreak()

					return fs.appendFile(path + fileName, msg, function(err) {
						if (err)
							console.log("Não é possível registrar os logs de " + fileKindStr + ". Details : " + err)
						else {
							if (verbose != 0) 
								console.log(msgNoLN)
						}
						return callback()
					})
				})
		    	})
		})
	},	
}

module.exports = {
	saveAccessLog : function(req, msg, callback) {
		return Logger.writeToFile(req, msg, callback, 0)
	},
	saveErrorLog : function(req, msg, callback) {
		return Logger.writeToFile(req, msg, callback, 1)
	}
}
